<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuardian - Location</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-white min-h-screen">
    <!-- Loading Spinner -->
    <div class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50" id="loadingSpinner">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center border">
            <div class="w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-black font-bold">Getting your location...</p>
        </div>
    </div>

    <div class="p-4 min-h-screen">
        <!-- Header -->
        <div class="text-center mb-6">
            <div class="flex items-center justify-center mb-2">
                <img src="Files/logo.png" alt="GeoGuardian Logo" class="w-12 h-12 mr-3 rounded-full">
                <h1 class="text-3xl font-bold text-black">GeoGuardian</h1>
            </div>
            <p class="text-black font-semibold text-sm">Your Agricultural Location Hub</p>
        </div>

        <!-- Map Container -->
        <div class="relative mb-6">
            <!-- Map -->
            <div id="map" class="h-96 w-full rounded-xl shadow-2xl opacity-0 transform scale-95 transition-all duration-1000"></div>

            <!-- Center Button -->
            <button class="absolute bottom-4 right-4 bg-white hover:bg-gray-50 p-4 rounded-full shadow-lg transition-all duration-200 hover:shadow-xl" id="centerButton" onclick="centerOnLocation()">
                <i class="fas fa-crosshairs text-green-600 text-xl"></i>
            </button>
        </div>

        <!-- Location Information Card -->
        <div class="bg-white bg-opacity-95 backdrop-blur-sm rounded-lg p-4 shadow-lg border mb-6 transform translate-y-4 opacity-0 transition-all duration-800" id="locationOverlay">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-black">Current Location</h3>
                <div class="flex items-center text-green-600">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                    <span class="text-sm font-bold">Live</span>
                </div>
            </div>

            <div class="space-y-2 text-sm">
                <div class="flex items-start">
                    <i class="fas fa-map-marker-alt text-green-500 mt-1 mr-3 w-4"></i>
                    <span class="text-black font-bold" id="currentAddress">Locating...</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-crosshairs text-blue-500 mr-3 w-4"></i>
                    <span class="text-black font-bold font-mono text-xs" id="coordinates">--</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-bullseye text-orange-500 mr-3 w-4"></i>
                    <span class="text-black font-bold">Accuracy: <span id="accuracy" class="font-bold">--</span>m</span>
                </div>
            </div>
        </div>

        <!-- Continue Button -->
        <div class="fixed bottom-6 left-4 right-4">
            <button class="btn btn-success w-full text-lg font-medium" id="continueBtn" onclick="continueToNextPage()">
                <i class="fas fa-arrow-right mr-2"></i>
                Continue
            </button>
        </div>
    </div>

    <!-- Include location.js for DOM manipulation -->
    <script src="location.js"></script>

    <script>
        let map;
        let marker;
        let accuracyCircle;
        let userLocation = null;
        let watchId = null;

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });

        // Initialize Leaflet Map
        function initMap() {
            console.log('Initializing Leaflet Map...');

            // Create map centered on default location
            map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView([40.7128, -74.0060], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Start location tracking immediately
            startLocationTracking();
        }

        // Start continuous location tracking
        function startLocationTracking() {
            console.log('Starting location tracking...');

            if (!navigator.geolocation) {
                showError("Geolocation not supported by this browser");
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 10000
            };

            navigator.geolocation.getCurrentPosition(
                onLocationUpdate,
                onLocationError,
                options
            );

            watchId = navigator.geolocation.watchPosition(
                onLocationUpdate,
                onLocationError,
                options
            );
        }

        // Handle location updates
        function onLocationUpdate(position) {
            console.log('Location update received:', position);

            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            userLocation = [lat, lng];

            // Hide loading spinner on first location
            hideLoadingSpinner();

            // Update map center
            map.setView(userLocation, 16);

            // Remove existing marker and accuracy circle
            if (marker) map.removeLayer(marker);
            if (accuracyCircle) map.removeLayer(accuracyCircle);

            // Create custom marker (blue dot)
            marker = L.circleMarker(userLocation, {
                color: 'white',
                weight: 3,
                fillColor: '#4285f4',
                fillOpacity: 1,
                radius: 8
            }).addTo(map);

            // Create accuracy circle
            accuracyCircle = L.circle(userLocation, {
                color: '#4285f4',
                weight: 1,
                opacity: 0.5,
                fillColor: '#4285f4',
                fillOpacity: 0.1,
                radius: accuracy
            }).addTo(map);

            // Update UI
            updateLocationInfo(lat, lng, accuracy);
            getAddressFromCoordinates(lat, lng);
        }

        // Handle location errors
        function onLocationError(error) {
            console.error('Location error:', error);
            hideLoadingSpinner();

            let errorMessage = "Unable to get your location";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Location access denied. Please enable location services and refresh the page.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Location request timed out.";
                    break;
            }

            document.getElementById('currentAddress').textContent = errorMessage;
            document.getElementById('loadingSpinner').innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg text-center border">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <h2 class="text-xl font-bold text-black mb-2">Location Error</h2>
                    <p class="text-black font-bold mb-4 text-center">${errorMessage}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Try Again</button>
                </div>
            `;
        }

        // Update location information display
        function updateLocationInfo(lat, lng, accuracy) {
            document.getElementById('coordinates').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('accuracy').textContent = Math.round(accuracy);

            // Show location card with Tailwind classes
            setTimeout(() => {
                const overlay = document.getElementById('locationOverlay');
                overlay.classList.remove('opacity-0', 'translate-y-4');
                overlay.classList.add('opacity-100', 'translate-y-0');
            }, 500);
        }

        // Get human-readable address
        async function getAddressFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();

                if (data && data.display_name) {
                    document.getElementById('currentAddress').textContent = data.display_name;
                } else {
                    document.getElementById('currentAddress').textContent = 'Address not found';
                }
            } catch (error) {
                console.error('Error getting address:', error);
                document.getElementById('currentAddress').textContent = 'Address lookup failed';
            }
        }

        // Hide loading spinner
        function hideLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.add('opacity-0', 'pointer-events-none');

            // Show map after spinner is hidden
            setTimeout(() => {
                const mapEl = document.getElementById('map');
                mapEl.classList.remove('opacity-0', 'scale-95');
                mapEl.classList.add('opacity-100', 'scale-100');
            }, 300);
        }

        // Center map on user location
        function centerOnLocation() {
            if (userLocation) {
                map.setView(userLocation, 18);
            }
        }

        // Continue to next page
        function continueToNextPage() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }

            if (userLocation) {
                localStorage.setItem('userLocation', JSON.stringify({
                    lat: userLocation[0],
                    lng: userLocation[1]
                }));
            }

            // Redirect directly to home.html
            window.location.href = 'home.html';
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && userLocation) {
                centerOnLocation();
            }
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
</html>